<%
  # You can inline erb variables
  app_dir = '/usr/local/www/current/buyma_insider'
  bin_dir = '/usr/local/bin'
  unicorn_workers   = 2 # correspond to workers instance in unicorn
  sidekiq_processes = 1 # number of sidekiq processes
%>


set log syslog
set daemon 120
set httpd
    port 2812
    allow snw:"123"

set onreboot start

check process nginx with pidfile <%= shared_path %>/tmp/pids/nginx.pid
  group www
  start program = "<%= bin_dir %>/nginx" with timeout 60 seconds
  stop program = "<%= bin_dir %>/nginx -s quit"

check process unicorn_master with pidfile <%= shared_path %>/tmp/pids/unicorn.pid
  group www
  start program = "<%= app_dir %>/bin/unicorn -I<%= current_path %>/app -c<%= current_path %>/config/unicorn.rb"
  stop program = "kill -QUIT `cat <%= shared_path %>/tmp/pids/unicorn.pid`"

<% 1.upto(unicorn_workers).each do |index| %>
  check process unicorn_worker_<%= index %> with pidfile <%= shared_path %>/tmp/pids/unicorn.<%= index %>.pid
  group www
  start program = "/bin/cat /dev/null"
  stop program = "/usr/local/bin/unicorn kill_worker <%= index %>"
<% end %>

check process rethinkdb with pidfile <%= app_dir %>/tmp/pids/rethinkdb.pid
  group database
  start program = "<%= bin_dir %>/brew services start rethinkdb" with timeout 60 seconds
  stop program = "<%= bin_dir %>/brew services stop rethinkdb"

check process redis with pidfile /usr/local/var/run/redis.pid
  group database
  start program = "<%= bin_dir %>/brew services start redis" with timeout 60 seconds
  stop program = "<%= bin_dir %>/brew services stop redis"

check process elasticsearch with pidfile /usr/local/var/run/elasticsearch.pid
  group database
  start program = "<%= bin_dir %>/elasticsearch -d --pid /usr/local/var/run/elasticsearch.pid"
  stop program = "kill -QUIT `cat /usr/local/var/run/elasticsearch.pid`"

<% 1.upto(sidekiq_processes).each do |index| %>
check process sidekiq_<%= index %> with pidfile <%= app_dir %>/tmp/pids/<%= sidekiq %>_<%= index %>.pid
  group worker
  start program = ""
  stop program = "/usr/bin/kill -TERM `cat <%= shared_path %>/tmp/pids/sidekiq.pid`"
<% end %>

